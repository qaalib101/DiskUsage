<div class="container">
    <div class="jumbotron">
        <h1>Welcome to {{title}}</h1>
    </div>
</div>
<script id="donutchart" type="text/x-handlebars-template">
    {{donutchart}}
</script>
<div id="result" style="width: 900px; height: 500px;">

</div>
Total disk space: {{disk.total}} bytes
<br>
Total disk used: {{disk.used}} bytes
<br>
Total disk free: {{disk.free}} bytes
<br>
<input class="btn btn-default" type="file" id="FileUpload" onchange="listFiles(event)" webkitdirectory mozdirectory msdirectory odirectory directory multiple />
<script id="barChart" type="text/x-handlebars-template">
    {{barchart}}
</script>
<script id="pieChart" type="text/x-handlebars-template">
    {{piechart}}
</script>
<script id="dateChart" type="text/x-handlebars-template">
    {{datechart}}
</script>
<div class="container" id="chartTabs">
    <h2>File Charts</h2>
    <br>
    <!-- Nav tabs -->
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-toggle="tab" href="#barResult">Top Files by Size</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#pieResult">Directory by File Type</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#dateResult">File Modification by date</a>
        </li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">
        <div id="barResult" class="container tab-pane active"><br>
        </div>
        <div id="pieResult" class="container tab-pane fade"><br>
        </div>
        <div id="dateResult" class="container tab-pane fade"><br>
        </div>
    </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"></script>
<script src="handlebars-v4.0.12.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script type="text/javascript">
    $("#chartTabs").hide();
    google.charts.load("current", {packages:["corechart", "bar"]});
    google.charts.setOnLoadCallback(drawChart);
    function drawChart() {
        $.get('/getDiskData', function(diskData){
            if(diskData){
                let free = diskData.free - 0;
                let used = diskData.used - 0;
                var data = google.visualization.arrayToDataTable([
                    ['Storage', 'Disk Usage'],
                    ['Empty',     free],
                    ['Used',      used]
                ]);

                var options = {
                    title: 'Total Disk Storage',
                    pieHole: 0.4,
                };
                var chart = new google.visualization.PieChart(document.getElementById('result'));
                var source   = document.getElementById('donutchart').innerHTML;
                var template = Handlebars.compile(source);
                var context = {donutchart: chart};
                var html    = template(context);
                document.getElementById('result').innerHTML = html;
                chart.draw(data, options);
            }else{
                alert("No data has been recieved");
            }
        });
    }
    function folderChart(files){
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'File Name');
        data.addColumn('number', 'File Size');
        for(var i = 0; i<files.length; i++){
            data.addRows([
                [files[i].name, files[i].size]
            ])
        }
        var options = {
            title: 'Top files by size in directory',
            hAxis: {
                title: 'File Size',
            },
            vAxis: {
                title: 'File Name',
                showTextEvery: 10,
                slantedText: true,
                slantedTextAngle: 90,
                viewWindow:{max:10}
            },
            width:1100,
            height:600
        };

        var chart = new google.visualization.BarChart(document.getElementById('barResult'));

        var source   = document.getElementById('barChart').innerHTML;
        var template = Handlebars.compile(source);
        var context = {barchart: chart};
        var html    = template(context);
        document.getElementById('barResult').innerHTML = html;
        chart.draw(data, options);
    }
    function pieChart(files){
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'File Type');
        data.addColumn('number', 'File Size');
        for(var i =0; i<files.length; i++){
            data.addRows([
                [files[i].type, files[i].amount]
            ]);
        }

        var options = {
            title: 'Directory Usage by File Type',
            width: 900,
            height: 500,
        };
        var chart = new google.visualization.PieChart(document.getElementById('pieResult'));
        var source   = document.getElementById('pieChart').innerHTML;
        var template = Handlebars.compile(source);
        var context = {piechart: chart};
        var html    = template(context);
        document.getElementById('pieResult').innerHTML = html;
        chart.draw(data, options);
    }
    function dateChart(files){
        var data = new google.visualization.DataTable();
        data.addColumn('date', 'File Year');
        data.addColumn('number', 'Amount of files');
        for(var i = 0; i<files.length; i++){
            data.addRows([
                [files[i].date, files[i].amount]
            ])
        }
        var options = {
            title: 'Grouping files by date',
            hAxis: {
                title: 'Date',
                format:'yyyy',
                gridlines:{
                    count:6
                }

            },
            vAxis: {
                title: 'Amount of files',
                viewWindow:{
                    min: 0
                }
            },
            width: 900,
            height: 500
        };

        var chart = new google.visualization.LineChart(document.getElementById('dateResult'));


        var source   = document.getElementById('dateChart').innerHTML;
        var template = Handlebars.compile(source);
        var context = {datechart: chart};
        var html    = template(context);
        document.getElementById('dateResult').innerHTML = html;
        chart.draw(data, options);
    }
    function listFiles(event) {
        var files = [];
        var theFiles = event.target.files;
        for (var i = 0; i < theFiles.length; i++) {
            files[i] = {
                name: theFiles[i].name,
                type: theFiles[i].type,
                size: theFiles[i].size,
                date: theFiles[i].lastModifiedDate
            }
        }
        var topFiles = getTopFiles(files);
        var fileTypes = getFileTypes(files);
        var dateArray = groupBy(files, 'date');
        google.charts.setOnLoadCallback(folderChart(topFiles));
        google.charts.setOnLoadCallback(pieChart(fileTypes));
        google.charts.setOnLoadCallback(dateChart(dateArray));
        $("#chartTabs").show();
    }
    function getTopFiles(files){
        var topFiles = [];
        var breakingPoint = 10;
        if(files.length < 10){
            breakingPoint = files.length
        }
        var files2 = files.concat();
        for( i=0; i<breakingPoint; i++){
            var res = Math.max.apply(Math,files2.map(function(o){return o.size;}));
            var obj = files2.find(o => o.size === res);
            topFiles[i] = obj;
            files2.splice(files2.indexOf(obj), 1);
        }
        return topFiles;
    }
    function getFileTypes(files){
          var fileTypes = [
              {
                  type: "application",
                  amount: 0 },
              {
                  type:"text",
                  amount:0 },
              {
                  type:"image",
                  amount:0 },
              {
                  type:"video",
                  amount:0 },
              {
                  type:"other",
                  amount: 0}
          ];
          for(var i = 0; i < files.length; i++){
              var isOther = true;
              var fileType = files[i].type;
              var mimeType = fileType.split("/")[0];
              for(var n = 0; n < fileTypes.length; n++){
                  if(fileTypes[n].type == mimeType){
                      fileTypes[n].amount += 1;
                      isOther = false;
                  }
              }
              if(isOther == true){
                  fileTypes[4].amount += 1;
              }
          }
          return fileTypes;
    }
    function groupBy(files, property) {
        var i = 0, val, result = [];
        for (; i < files.length; i++) {
            var isOther = true;
            val = files[i][property].getFullYear();
            for(var n=0; n<result.length; n++){
                if(result[n].date.getFullYear()===val){
                    result[n].amount += 1;
                    isOther = false;
                }
            }
            if(isOther === true) {
                result.push({
                    date: new Date(val, 0),
                    amount: 1
                });
            }
        }
        result.sort(function(a, b){
            return a.date.getFullYear()-b.date.getFullYear();
        });
        return result;
    }
</script>
